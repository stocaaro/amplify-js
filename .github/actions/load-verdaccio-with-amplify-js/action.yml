name: Load Verdaccio with AmplifyJs
description: Turn on Verdaccio and load up all of the AmplifyJS build artifacts

runs:
  using: 'composite'
  steps:
    - name: Setup Node.js 16
      uses: actions/setup-node@64ed1c7eab4cce3362f8c340dee64e5eaeef8f7c # v3.6.0 https://github.com/actions/setup-node/commit/64ed1c7eab4cce3362f8c340dee64e5eaeef8f7c
      with:
        node-version: 16
      env:
        SEGMENT_DOWNLOAD_TIMEOUT_MINS: 2
    - name: Start verdaccio
      run: |
        cat /etc/os-release
        apt update
        apt install netcat -y
        npx verdaccio@5.25.0 &
        while ! nc -z 127.0.0.1 4873; do
          echo "Verdaccio not running yet"
          sleep 1
        done

        # Run your commands after verdaccio is up and running
        echo "Verdaccio is up and running, proceeding with the script..."
      shell: bash
    - name: Publish to verdaccio
      shell: bash
      working-directory: ./aws-amplify
      run: |
        cat /etc/os-release
        npm i -g npm-cli-adduser
        npm-cli-adduser
        sleep 1
        yarn config set registry $NPM_REGISTRY
        npm set registry $NPM_REGISTRY
        git config --global user.email $NPM_EMAIL
        git config --global user.name $NPM_USER
        git status
        git --no-pager diff
        .circleci/retry-yarn-script.sh -s publish:verdaccio -n 1 -r true
        yarn info aws-amplify@unstable description
        npm info aws-amplify@unstable version
